# v0.4.0 Development Summary

**Compiled**: February 17, 2026
**Status**: Pre-release
**Previous Release**: v0.3.2 (January 30, 2026)

---

## Overview

Version 0.4.0 represents a major feature release for the Zotero RAG Assistant, introducing metadata-aware search with Reciprocal Rank Fusion (RRF), a multi-tab sidebar panel system, LM Studio support, dynamic model discovery across all providers, AI reasoning display, settings restructuring, and Semantic Scholar integration. The release also includes significant bug fixes for Linux stability and a complete overhaul of the metadata migration system.

---

## Feature Summary

### 1. Metadata Filtering & RRF Hybrid Search

**Core enhancement to the retrieval pipeline.**

- **Two-tier metadata extraction** from user queries: fast regex-based keyword detection (< 5ms) for 80% of queries, with LLM fallback (300-500ms) for complex/ambiguous queries
- **Reciprocal Rank Fusion (RRF)**: Replaced simple union-based result merging with proper RRF score fusion (k=60 standard), combining BM25 sparse retrieval and dense semantic embeddings
- **ChromaDB-only filtering architecture**: All metadata filtering happens in ChromaDB at query time, eliminating Zotero SQLite locking issues. Metadata is stored during indexing with year as integer, tags/collections as pipe-separated strings
- **Fallback logic**: If strict filters eliminate most results (< 5), automatically retries without filters to prevent zero-result queries
- **Three search modes**: Original (classic hybrid), Metadata-Enhanced (with RRF + filtering), configurable via UI
- **Three filter modes**: Manual (Scope panel only), AI Auto (extract from query text), Hybrid (both sources, recommended)
- **Sentinel values for ChromaDB**: Year uses `-1` instead of `None` (ChromaDB strips None values); tags/collections use empty strings

**Files created**: `backend/metadata_extractor.py`, `backend/metadata_utils.py`, `backend/metadata_version.py`, `backend/metadata_migration.py`, `frontend/src/contexts/SearchSettingsContext.tsx`

**Files modified**: `backend/vector_db.py` (added `query_hybrid_rrf()`), `backend/interface.py` (updated chat pipeline), `backend/main.py` (migration + filter endpoints), `frontend/src/hooks/useChat.ts`, `frontend/src/types/api.ts`, `frontend/src/contexts/ChatContext.tsx`

**Key design decisions**:
- ChromaDB-only at query time (no SQLite locking)
- Year stored as integer for range queries (`$gte`, `$lte`)
- Feature-flagged via environment variable `ZOTERO_RAG_METADATA_FILTERING`
- Metadata migration updates metadata without re-embedding (5-10 min vs 30-60 min full reindex)

---

### 2. Multi-Tab Left Panel (Sidebar Tabs)

**VS Code-inspired sidebar tab system for extensible panel navigation.**

- Icon-based tab navigation with tooltips
- Two tabs implemented: **Evidence** (existing SnippetsPanel) and **Scope** (new PromptScaffoldingPanel)
- Active tab persisted in localStorage
- Smooth transitions, independent collapse state

**Files created**: `frontend/src/components/layout/SidebarTabs.tsx`, `frontend/src/styles/sidebar-tabs.css`

**Files modified**: `frontend/src/components/layout/AppShell.tsx`, `frontend/src/contexts/SessionsContext.tsx`

---

### 3. Scope Panel (Prompt Scaffolding)

**UI for filtering the library with tags, collections, date ranges, and item types.**

- Search engine mode toggle (Original vs Metadata-Enhanced)
- Filter mode toggle (Manual / AI Auto / Hybrid)
- Tag selection from library (loaded from backend)
- Collection selection with item counts
- Year range inputs
- Estimated item count preview
- Clear filters functionality
- Sections gray out contextually based on active mode

**Files created**: `frontend/src/features/prompts/PromptScaffoldingPanel.tsx`, `frontend/src/styles/prompt-scaffolding.css`

**Backend endpoints added**: `GET /api/library/tags`, `GET /api/library/collections`, `POST /api/filters/estimate`, `GET /api/library/item_types`

---

### 4. LM Studio Support

**Second local LLM provider alongside Ollama.**

- OpenAI-compatible API on default port 1234
- Model listing via `/v1/models`, chat via `/v1/chat/completions`
- Connection test, base URL configuration
- Both Ollama and LM Studio can be enabled simultaneously

**Files created**: `backend/model_providers/lmstudio.py`

**Files modified**: `backend/model_providers/__init__.py`, `frontend/src/contexts/SettingsContext.tsx`, `frontend/src/pages/Settings.tsx`

---

### 5. Dynamic Model Discovery

**All external API providers now auto-discover available models.**

- **Supported providers**: OpenAI, Google Gemini, Mistral, Groq, OpenRouter (local providers already had this)
- Each provider implements `validate_credentials_and_list_models()` that validates API key AND fetches available models in one call
- Frontend stores discovered models directly from validation response
- Graceful fallback to static model lists if discovery fails
- Active Model Panel now filters to show only properly configured providers (cloud providers need API key, local providers just need to be enabled)

**Files modified**: `backend/model_providers/openai.py`, `backend/model_providers/additional.py`, `backend/main.py`, `frontend/src/pages/Settings.tsx`, `frontend/src/features/models/ActiveModelPanel.tsx`

---

### 6. AI Reasoning Display

**Collapsible display of LLM reasoning/thinking steps.**

- Extracts `<think>...</think>` content from LLM responses (e.g., Phi models)
- Collapsed by default to reduce cognitive load
- Smooth expand/collapse animation
- Styled with subtle background and left border accent
- Persists across sessions, backward compatible

**Files created**: `frontend/src/components/ui/ReasoningSection.tsx`

**Files modified**: `backend/interface.py` (reasoning extraction), `frontend/src/features/chat/ChatMessages.tsx`, `frontend/src/styles/globals.css`

---

### 7. Settings Restructuring

**Tab-based settings organization.**

- **General** tab: Zotero path, Chrome path, embedding model
- **Local Models** tab: Ollama, LM Studio
- **Cloud Providers** tab: OpenAI, Anthropic, Google, Mistral, Groq, OpenRouter
- **Active Model** tab: Provider/model selection for chat

**Files modified**: `frontend/src/pages/Settings.tsx`, `frontend/src/styles/settings.css`

---

### 8. Semantic Scholar Integration

**Paper metadata lookup from Sources panel.**

- Semantic Scholar button alongside Google Scholar in source cards
- DOI-first lookup with title/author fallback
- Modal displaying abstract, metadata, citations, references
- Backend endpoint: `POST /api/external/semantic_scholar`

**Files created**: `frontend/src/components/sources/SemanticScholarModal.tsx`, `frontend/src/styles/semantic-scholar-modal.css`, `frontend/src/api/metadata.ts`

**Files modified**: `frontend/src/features/sources/SourcesPanel.tsx`, `backend/external_api_utils.py`, `backend/main.py`

---

### 9. Metadata Migration System

**Complete overhaul of the migration infrastructure.**

- **Root cause fixed**: `_fetch_updated_metadata()` was calling `search_parent_items_with_pdfs(item_ids=...)` which doesn't accept that parameter, causing silent TypeError on every chunk
- **Solution**: Pre-load ALL Zotero items upfront into a cache dictionary (O(1) lookups instead of O(n) failing queries)
- **Performance**: 43,754 chunks in ~7 seconds (was failing in 1 second with 0 updates)
- Version detection system (v0 empty, v1 legacy/string year, v2 current/int year)
- API endpoints: `GET /api/metadata/version`, `POST /api/metadata/migrate`
- Frontend migration banner with progress tracking

**Files created**: `frontend/src/components/ui/MigrationBanner.tsx`, `frontend/src/contexts/MigrationContext.tsx`, `frontend/src/styles/migration-banner.css`, `frontend/src/styles/migration-settings.css`

---

### 10. Linux Stability Fixes (from v0.3.3-dev)

**Comprehensive crash resolution for Ubuntu 24.04 and other Linux distributions.**

- **Root cause**: Electron renderer crashed due to GPU/sandbox incompatibilities; no error handlers masked the real problem
- Added renderer crash handlers (`render-process-gone`, `did-fail-load`, `unresponsive`)
- Platform-specific window configuration (removed macOS-only `titleBarStyle: 'hiddenInset'` from Linux)
- Command-line flag support (`--no-sandbox`, `--disable-gpu`, `--ozone-platform=x11`, etc.)
- Safe defaults on Linux: disables GPU sandbox, uses desktop OpenGL
- Created Linux post-install script for .deb packages

**Files modified**: `electron/main.ts`

---

## Architecture Highlights

### Retrieval Pipeline (Enhanced)

```
Query -> Condense -> Extract Metadata -> Build Where Clause -> Hybrid RRF Search -> Rerank -> Generate
                                                              |
                                                        Fallback if < 5 results
```

### ChromaDB Metadata Schema (v2)

```python
{
    "item_id": 123,          # Integer
    "title": "Paper Title",
    "authors": "Smith, Jones",
    "year": 2020,            # Integer (-1 = no year)
    "tags": "NLP|ML",        # Pipe-separated (empty string if none)
    "collections": "PhD",    # Pipe-separated (empty string if none)
    "item_type": "journalArticle",
    "chunk_idx": 0,
    "page": 12,
    "pdf_path": "/path/to/pdf"
}
```

### Frontend Context Hierarchy

```
SettingsProvider
  -> SearchSettingsProvider
    -> SessionsProvider
      -> MigrationProvider
        -> ChatProvider
          -> App
```

---

## Known Limitations (v0.4.0)

- Item type filtering: UI exists but not fully connected to query pipeline
- Filter preview count is estimated, not exact
- No saved filter presets
- No "NOT" operator for filters (e.g., "exclude tag X")
- Scope panel real-time year input validation not implemented
- Semantic Scholar rate limits not handled with backoff

---

## Future Enhancements (v0.5.0+)

- Implement saved filter presets per profile
- Advanced filter operators (NOT, complex boolean)
- Real-time streaming of reasoning during generation
- Batch API key validation
- Provider usage analytics (tokens, costs)
- Filter statistics showing item distribution
- Export filtered results to Zotero collection

---

## Development Artifacts

The following files were created during development for debugging, testing, and planning purposes. They are not part of the application and can be removed for a clean release:

### Root-level debug/test scripts
- `analyze_chroma.py` - ChromaDB database analyzer
- `check_db_format.py` - Metadata format checker
- `debug_migration.py` - Migration debugging script
- `fix_profile_data.py` - Profile data migration helper
- `migrate_item_types.py` - Item type migration script
- `test_item_types.py` - Item type filtering tests
- `test_itemids.py` - Item ID matching tests
- `trace_chatbot.py` - Chatbot initialization tracer

### Root-level development docs (content consolidated here)
- `LINUX_FIX_SUMMARY.md` - Linux crash fix summary
- `MIGRATION_FIX_SUMMARY.md` - Migration fix summary
- `MIGRATION_REDESIGN.md` - Migration redesign analysis (Python docstring format)

### Scripts directory test files
- `scripts/test_retrieval_snippets.py` - Retrieval testing
- `scripts/test_trial_queries.py` - Trial query testing

### Docs directory (agentic development instruction files)
- `docs/AI_REASONING_DISPLAY.md`
- `docs/METADATA_FILTERING_PLAN.md`
- `docs/METADATA_FILTERING_IMPLEMENTATION_COMPLETE.md`
- `docs/SCOPE_PANEL_INTEGRATION.md`
- `docs/google_dynamic_discovery.md`
- `docs/LINUX_CRASH_FIX_v0.3.3.md`
- `docs/RELEASE_PLAN_v0.4.0.md`

### Other
- `addons/just-maybe-577.mp3` - Audio file (not part of application)
- `build.log` - Build output log
