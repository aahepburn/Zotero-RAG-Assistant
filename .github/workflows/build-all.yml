name: Build All Platforms

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      version:
        description: 'Version number (e.g., 0.1.4)'
        required: true
  push:
    tags:
      - 'v*'  # Trigger on version tags

permissions:
  contents: write

jobs:
  build-all:
    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            name: linux
          - os: macos-15-intel  # Intel x64
            name: macos
            arch: x64
          - os: macos-14  # Apple Silicon arm64
            name: macos
            arch: arm64
          - os: windows-latest
            name: windows
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install Node dependencies
        run: |
          npm install
          cd frontend && npm install
      
      # macOS Python setup - Use PyInstaller bundle
      - name: Create Python bundle with PyInstaller (macOS)
        if: runner.os == 'macOS'
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install pyinstaller
          
          # Handle Intel Mac (x64) PyTorch compatibility
          # PyTorch 2.6+ required for security (CVE-2025-32434) but no x64 wheels available
          # Intel runners use 2.2.2 (last version with x64 support) for build only
          # Built app uses safetensors which mitigates the vulnerability
          if [ "$(uname -m)" = "x86_64" ]; then
            echo "Intel Mac detected - using PyTorch 2.2.2 for x64 compatibility"
            python3 -m pip install torch==2.2.2
            # Install requirements but skip torch (already installed)
            grep -v "^torch" requirements.txt > requirements-no-torch.txt
            python3 -m pip install -r requirements-no-torch.txt
          else
            echo "Apple Silicon detected - using standard requirements"
            python3 -m pip install -r requirements.txt
          fi
          
          # Build PyInstaller bundle (will build for native architecture of runner)
          echo "Building for ${{ matrix.arch }} architecture on $(uname -m) runner"
          pyinstaller --clean --noconfirm backend_bundle.spec
          
          # Verify architecture
          file python-dist/backend_server | head -1
          
          # Move PyInstaller output to python-dist
          if [ -d "dist/backend_bundle" ]; then
            mv dist/backend_bundle python-dist
          fi
      
      # Linux: Verify Python is available (will be installed by app on first run)
      - name: Verify Python available (Linux)
        if: runner.os == 'Linux'
        run: |
          python3 --version
          echo "Python will be installed by the app on first run using system Python"
      
      # Windows Python setup - Use PyInstaller bundle
      - name: Create Python bundle with PyInstaller (Windows)
        if: runner.os == 'Windows'
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyinstaller
          python -m pip install -r requirements.txt
          pyinstaller --clean --noconfirm backend_bundle.spec
          
          # Move PyInstaller output to python-dist
          if (Test-Path "dist\backend_bundle") {
            Move-Item -Path "dist\backend_bundle" -Destination "python-dist"
          }
        shell: pwsh
      
      - name: Verify Python environment (macOS)
        if: runner.os == 'macOS'
        run: |
          if [ -f "python-dist/backend_server" ]; then
            echo "✓ Backend executable created successfully"
            ls -lh python-dist/ | head -10
            
            # Verify architecture
            echo ""
            echo "Verifying architecture..."
            file python-dist/backend_server
            echo "Note: Built on Apple Silicon (arm64). Intel Macs will run via Rosetta 2."
          else
            echo "✗ Backend executable not found!"
            exit 1
          fi
      
      - name: Verify Python environment (Windows)
        if: runner.os == 'Windows'
        run: |
          if (Test-Path "python-dist\backend_server.exe") {
            Write-Host "Backend executable created successfully"
            Get-ChildItem python-dist -Recurse | Select-Object -First 10
          } else {
            Write-Error "Backend executable not found!"
            exit 1
          }
        shell: pwsh
      
      - name: Build application
        run: npm run build
      
      # Completely remove release directory to start fresh
      - name: Remove release directory (Linux/macOS)
        if: runner.os != 'Windows'
        run: rm -rf release
      
      - name: Remove release directory (Windows)
        if: runner.os == 'Windows'
        run: if (Test-Path "release") { Remove-Item -Path "release" -Recurse -Force -ErrorAction SilentlyContinue }
        shell: pwsh
      
      # Platform-specific packaging
      - name: Package Linux
        if: runner.os == 'Linux'
        run: npm run package:linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USE_HARD_LINKS: "false"
      
      - name: Package macOS
        if: runner.os == 'macOS'
        run: |
          max_attempts=3
          attempt=1
          success=false
          
          while [ $attempt -le $max_attempts ] && [ "$success" != "true" ]; do
            echo "Build attempt $attempt of $max_attempts for ${{ matrix.arch }}..."
            if npm run package:mac -- --${{ matrix.arch }}; then
              success=true
              echo "Build succeeded on attempt $attempt"
            else
              if [ $attempt -eq $max_attempts ]; then
                echo "Build failed after $max_attempts attempts"
                exit 1
              fi
              echo "Build failed on attempt $attempt. Retrying in 10 seconds..."
              sleep 10
              # Clean up any mounted volumes
              hdiutil detach /Volumes/ZoteroRAG* 2>/dev/null || true
              rm -rf release/*.dmg 2>/dev/null || true
              attempt=$((attempt + 1))
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Package Windows
        if: runner.os == 'Windows'
        run: |
          $maxAttempts = 3
          $attempt = 1
          $success = $false
          
          while ($attempt -le $maxAttempts -and -not $success) {
            Write-Host "Build attempt $attempt of $maxAttempts..."
            try {
              npm run package:win
              $success = $true
              Write-Host "Build succeeded on attempt $attempt"
            }
            catch {
              if ($attempt -eq $maxAttempts) {
                Write-Error "Build failed after $maxAttempts attempts"
                exit 1
              }
              Write-Host "Build failed on attempt $attempt. Retrying in 10 seconds..."
              Start-Sleep -Seconds 10
              $attempt++
            }
          }
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # Upload artifacts
      - name: Upload Linux artifacts
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            release/*.AppImage
            release/*.deb
            release/*.tar.gz
            release/latest-linux.yml
          retention-days: 30
      
      - name: Upload macOS artifacts
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}-installers
          path: |
            release/*.dmg
            release/*.zip
            release/latest-mac.yml
          retention-days: 30
      - name: Upload Windows artifacts
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: windows-installers
          path: |
            release/*.exe
            release/*.zip
            release/latest.yml
          retention-days: 30

  create-release:
    needs: build-all
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure
        run: ls -R artifacts

      - name: Setup Node.js for merge script
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install js-yaml
        run: npm install js-yaml

      - name: Merge macOS update manifests
        run: |
          node scripts/merge-mac-yml.js \
            artifacts/macos-x64-installers/latest-mac.yml \
            artifacts/macos-arm64-installers/latest-mac.yml \
            artifacts/latest-mac.yml
          echo "Merged latest-mac.yml created"
          cat artifacts/latest-mac.yml

      - name: Consolidate all release files
        run: |
          mkdir -p artifacts/release
          # Move merged yml
          mv artifacts/latest-mac.yml artifacts/release/
          # Move macOS installers (removing individual yml files first)
          rm -f artifacts/macos-x64-installers/latest-mac.yml
          rm -f artifacts/macos-arm64-installers/latest-mac.yml
          mv artifacts/macos-x64-installers/* artifacts/release/ || true
          mv artifacts/macos-arm64-installers/* artifacts/release/ || true
          # Move Windows and Linux artifacts
          mv artifacts/windows-installers/* artifacts/release/ || true
          mv artifacts/linux-packages/* artifacts/release/ || true
          # Show what we have
          ls -la artifacts/release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/release/*
          draft: false
          prerelease: false
          generate_release_notes: true
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
